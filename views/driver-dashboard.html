<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Service - Chauffeur Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
         :root {
            --primary: #3498db;
            --secondary: #2980b9;
            --dark: #1e2387;
            --light: #ecf0f1;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --bs-primary-rgb: 52, 152, 219;
            /* For Bootstrap utilities */
            --bs-success-rgb: 46, 204, 113;
            --bs-warning-rgb: 243, 156, 18;
            --bs-danger-rgb: 231, 76, 60;
            /* Added for consistency */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            /* Slightly lighter grey */
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            /* Slightly wider */
            background-color: var(--dark);
            color: white;
            padding: 20px 0;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 0 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .sidebar-header h3 {
            color: white;
            margin-bottom: 5px;
            font-size: 1.5rem;
        }
        
        .sidebar-header p {
            font-size: 0.85rem;
            color: #ffffffb3;
            margin-bottom: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            padding: 20px 25px;
            /* Increased padding */
            margin: 20px 0;
            border-top: 1px solid #ffffff0d;
            border-bottom: 1px solid #ffffff0d;
        }
        
        .avatar {
            width: 45px;
            /* Slightly larger */
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            /* Subtle border */
        }
        
        #user-name {
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .nav {
            flex-direction: column;
            padding: 0 15px;
            /* Consistent padding */
            flex-grow: 1;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 12px 20px;
            /* Increased padding */
            border-radius: 6px;
            /* Softer radius */
            margin-bottom: 8px;
            /* More spacing */
            display: flex;
            align-items: center;
            transition: all 0.2s ease-in-out;
            font-size: 0.95rem;
        }
        
        .nav-link i {
            margin-right: 12px;
            font-size: 1.2rem;
            width: 20px;
            /* Ensure icons align */
            text-align: center;
        }
        
        .nav-link:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.2);
            color: white;
            text-decoration: none;
        }
        
        .nav-link.active {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            /* Bolder active link */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item:last-child {
            /* For logout */
            margin-top: auto;
            /* Pushes logout to bottom */
            padding-bottom: 10px;
        }
        
        .nav-link#logout-btn:hover {
            background-color: var(--danger);
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 25px 30px;
            /* Increased padding */
            background-color: #ffffff;
        }
        
        .main-content header {
            /* Headers inside content sections */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
            /* Softer border */
        }
        
        .main-content header h1 {
            font-size: 1.8rem;
            /* Slightly larger */
            color: var(--dark);
            font-weight: 600;
        }
        
        .date-time {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            /* Wider minmax */
            gap: 25px;
            /* Increased gap */
            margin-bottom: 35px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            /* Softer radius */
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            /* Softer shadow */
            text-align: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .stat-card i {
            font-size: 2.2rem;
            /* Slightly larger */
            margin-bottom: 15px;
        }
        /* Varied icon colors */
        
        .stat-card:nth-child(1) i {
            color: var(--primary);
        }
        
        .stat-card:nth-child(2) i {
            color: var(--success);
        }
        
        .stat-card:nth-child(3) i {
            color: var(--warning);
        }
        
        .stat-card h3 {
            font-size: 2rem;
            /* Larger number */
            margin: 10px 0;
            color: var(--dark);
            font-weight: 700;
        }
        
        .stat-card p {
            color: #5a6570;
            /* Darker muted text */
            margin: 0;
            font-size: 0.9rem;
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            padding: 25px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th,
        td {
            padding: 14px 18px;
            /* Increased padding */
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        th {
            background-color: #f8f9fa;
            /* Standard light grey for headers */
            font-weight: 600;
            color: var(--dark);
            font-size: 0.85rem;
            /* Slightly smaller */
            text-transform: uppercase;
            /* Uppercase headers */
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background-color: #f1f3f5;
            /* Softer hover */
        }
        
        .badge {
            padding: 6px 12px;
            /* Larger badges */
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.75rem;
            /* Standardized badge font size */
            line-height: 1;
        }
        
        .badge-success {
            background-color: rgba(var(--bs-success-rgb), 0.15);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: rgba(var(--bs-warning-rgb), 0.15);
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: rgba(var(--bs-danger-rgb), 0.15);
            color: var(--danger);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .upcoming-trips h2 {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .trip-card {
            background-color: #fff;
            border: 1px solid #e0e5ec;
            /* Softer border */
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }
        
        .trip-card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            border-left-color: var(--secondary);
            /* Darker primary on hover */
            transform: translateY(-3px);
        }
        
        .trip-card .card-body {
            padding: 20px;
        }
        
        .trip-card .card-title {
            color: var(--dark);
            font-weight: 600;
            font-size: 1.15rem;
            margin-bottom: 8px;
        }
        
        .trip-card .card-text {
            color: #555e68;
            font-size: 0.9rem;
            margin-bottom: 5px;
            /* Compact text */
        }
        
        .trip-card .card-text i {
            margin-right: 8px;
            color: #777;
        }
        
        .trip-status {
            display: inline-block;
            padding: 5px 10px;
            /* Standardized padding */
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .status-scheduled {
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            color: var(--primary);
        }
        
        .status-in_progress,
        .status-in-progress {
            background-color: rgba(var(--bs-warning-rgb), 0.15);
            color: var(--warning);
        }
        
        .status-completed {
            background-color: rgba(var(--bs-success-rgb), 0.15);
            color: var(--success);
        }
        /* Responsive */
        
        @media (max-width: 992px) {
            .sidebar {
                /* Example: could be hidden and toggled on smaller screens */
                /* position: fixed; z-index: 1000; left: -260px; */
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
            }
            .nav-item:last-child {
                margin-top: 20px;
            }
            .main-content {
                padding: 20px;
            }
            .main-content header {
                flex-direction: column;
                align-items: flex-start;
            }
            .date-time {
                margin-top: 10px;
            }
            .stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            #trips-section .btn-group {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
            }
            #trips-section .btn-group .btn {
                flex-grow: 1;
                margin-bottom: 5px;
                font-size: 0.85rem;
            }
            #reservations-section .input-group {
                width: 100% !important;
            }
            .trip-card .card-body {
                padding: 15px;
            }
            .trip-card .card-title {
                font-size: 1.05rem;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>TransportDash</h3>
                <p>Chauffeur Panel</p>
            </div>

            <div class="user-info">
                <div class="avatar" id="user-avatar">BK</div>
                <span id="user-name"></span>
                <!-- Will be populated by JS -->
            </div>

            <ul class="nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="trips">
                        <i class="bi bi-geo-alt-fill"></i> My Trips
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="reservations">
                        <i class="bi bi-people-fill"></i> Reservations
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logout-btn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <header>
                    <h1>Dashboard Overview</h1>
                    <div class="date-time" id="current-date"></div>
                </header>

                <div class="stats">
                    <div class="stat-card">
                        <i class="bi bi-calendar-check-fill"></i>
                        <h3 id="assigned-trips-count">0</h3>
                        <p>Active Trips Assigned</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-truck-front-fill"></i>
                        <h3 id="total-capacity-count">0</h3>
                        <p>Total Capacity (Active)</p>
                    </div>
                    <div class="stat-card">
                        <i class="bi bi-check-circle-fill"></i>
                        <h3 id="completed-trips-count">0</h3>
                        <p>Completed Trips (Today)</p>
                    </div>
                </div>

                <div class="upcoming-trips">
                    <h2>Today's Scheduled Trips</h2>
                    <div id="today-trips-container">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Trips Section -->
            <div class="content-section" id="trips-section">
                <header>
                    <h1>My Assigned Trips</h1>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary active" data-filter="all">All Trips</button>
                        <button class="btn btn-outline-secondary" data-filter="scheduled">Scheduled</button>
                        <button class="btn btn-outline-secondary" data-filter="in_progress">In Progress</button>
                        <button class="btn btn-outline-secondary" data-filter="completed">Completed</button>
                    </div>
                </header>

                <div class="table-container">
                    <table id="trips-table">
                        <thead>
                            <tr>
                                <th>Route</th>
                                <th>Date</th>
                                <th>Departure</th>
                                <th>Arrival</th>
                                <th>Vehicle</th>
                                <th>Capacity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                    <div id="trips-table-message" class="text-center py-4" style="display: none;">
                        <!-- Filter messages will be displayed here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Reservations Section -->
            <div class="content-section" id="reservations-section">
                <header>
                    <h1>Passenger Reservations</h1>
                    <div class="input-group" style="width: 300px;">
                        <label class="input-group-text" for="trip-filter"><i class="bi bi-filter"></i></label>
                        <select class="form-select" id="trip-filter">
                            <option value="">Filter by Trip (All)</option>
                            <!-- Filled by JavaScript -->
                        </select>
                    </div>
                </header>

                <div class="table-container">
                    <table id="reservations-table">
                        <thead>
                            <tr>
                                <th>Passenger</th>
                                <th>Trip</th>
                                <th>Date</th>
                                <th>Seats</th>
                                <th>Payment</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentChauffeur = {};

        const trajets = [{
            idTrajet: 1,
            lieuDepart: "Alger",
            lieuArrivee: "Oran"
        }, {
            idTrajet: 2,
            lieuDepart: "Constantine",
            lieuArrivee: "Annaba"
        }, ];
        const localServicesMock = [{
            idService: 1,
            idTrajet: 1,
            heureDepart: "08:00:00",
            idChauffeur: 1,
            idMoyen: 1
        }, {
            idService: 2,
            idTrajet: 2,
            heureDepart: "15:00:00",
            idChauffeur: 1,
            idMoyen: 2
        }, ];
        const passagers = [{
            idPassager: 1,
            nom: "Meziane",
            prenom: "Yasmine",
            idUtilisateur: 3
        }, {
            idPassager: 2,
            nom: "W",
            prenom: "W",
            idUtilisateur: 4
        }, ];
        const reservations = [{
            idReservation: 1,
            dateReservation: "2025-05-09",
            etat: "confirmée",
            idPassager: 1,
            idService: 1,
            nbrPlaces: 1,
            statutPaiement: "unpaid"
        }, {
            idReservation: 2,
            dateReservation: "2025-05-09",
            etat: "en attente",
            idPassager: 1,
            idService: 2,
            nbrPlaces: 1,
            statutPaiement: "unpaid"
        }, {
            idReservation: 4,
            dateReservation: "2025-05-09",
            etat: "confirmed",
            idPassager: 2,
            idService: 1,
            nbrPlaces: 2,
            statutPaiement: "paid"
        }, ];
        const moyens = [{
            idMoyen: 1,
            type: "Bus",
            capacite: 50,
            matricule: "1234-DZ-16"
        }, {
            idMoyen: 2,
            type: "Taxi",
            capacite: 4,
            matricule: "5678-DZ-16"
        }, ];

        const currentDateElement = document.getElementById('current-date');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');
        const assignedTripsCountEl = document.getElementById('assigned-trips-count');
        const totalCapacityCountEl = document.getElementById('total-capacity-count');
        const completedTripsCountEl = document.getElementById('completed-trips-count');
        const todayTripsContainer = document.getElementById('today-trips-container');
        const tripsTableBody = document.querySelector('#trips-table tbody');
        const reservationsTableBody = document.querySelector('#reservations-table tbody');
        const tripFilterSelect = document.getElementById('trip-filter');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const logoutBtn = document.getElementById('logout-btn');

        async function fetchChauffeurProfile() {
            try {
                // MOCKING chauffeur profile for now
                currentChauffeur = {
                    id: 1,
                    nom: "Karim", // Switched order for display
                    prenom: "Belkacem",
                };
                loadUserData();
            } catch (error) {
                console.error("Error loading chauffeur profile:", error);
                userNameElement.textContent = "Driver";
                userAvatarElement.textContent = "D";
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            updateCurrentDate();
            await fetchChauffeurProfile();
            fetchAllDriverServices();
            loadReservations();
            setupEventListeners();
        });

        function updateCurrentDate() {
            if (!currentDateElement) return;
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            currentDateElement.textContent = now.toLocaleDateString('en-US', options);
        }

        function loadUserData() {
            if (userNameElement && currentChauffeur.prenom && currentChauffeur.nom) {
                userNameElement.textContent = `${currentChauffeur.prenom} ${currentChauffeur.nom}`;
            } else if (userNameElement) {
                userNameElement.textContent = "Chauffeur";
            }

            if (userAvatarElement && currentChauffeur.prenom && currentChauffeur.nom) {
                userAvatarElement.textContent = `${currentChauffeur.prenom.charAt(0)}${currentChauffeur.nom.charAt(0)}`;
            } else if (userAvatarElement) {
                userAvatarElement.textContent = "C";
            }
        }

        function getStatusClass(status) {
            if (!status) return 'text-muted';
            const normalizedStatus = String(status).toLowerCase().replace(/\s+/g, '_');
            switch (normalizedStatus) {
                case 'scheduled':
                    return 'status-scheduled';
                case 'in_progress':
                    return 'status-in_progress';
                case 'completed':
                    return 'status-completed';
                default:
                    return 'text-muted';
            }
        }

        function loadDashboardStats(servicesData) {
            let activeTripsCounter = 0;
            let completedTodayCounter = 0;
            let activeCapacitySum = 0;
            const today = new Date().toISOString().split('T')[0];

            servicesData.forEach(service => {
                const serviceDate = service.dateService ? service.dateService.split('T')[0] : null;
                const status = String(service.status || '').toLowerCase().replace(/\s+/g, '_');

                if (status === 'completed' && serviceDate === today) {
                    completedTodayCounter++;
                }

                if (status === 'scheduled' || status === 'in_progress') {
                    activeTripsCounter++;
                    activeCapacitySum += (service.capacite || 0);
                }
            });

            if (assignedTripsCountEl) assignedTripsCountEl.textContent = activeTripsCounter;
            if (totalCapacityCountEl) totalCapacityCountEl.textContent = activeCapacitySum;
            if (completedTripsCountEl) completedTripsCountEl.textContent = completedTodayCounter;
        }

        function loadTodayTrips(servicesData) {
            if (!todayTripsContainer) return;
            const today = new Date().toISOString().split('T')[0];

            const todaysServices = servicesData.filter(service => {
                const serviceDate = service.dateService ? service.dateService.split('T')[0] : null;
                return serviceDate === today;
            }).sort((a, b) => (a.heureDepart || "").localeCompare(b.heureDepart || ""));

            todayTripsContainer.innerHTML = '';

            if (todaysServices.length === 0) {
                todayTripsContainer.innerHTML = `<div class="alert alert-info mt-3"><i class="bi bi-info-circle-fill me-2"></i>No trips scheduled for today.</div>`;
                return;
            }

            todaysServices.forEach(service => {
                const tripCard = document.createElement('div');
                tripCard.className = 'card trip-card mb-3';

                let actionButtonHTML = '';
                const currentStatus = String(service.status || '').toLowerCase().replace(/\s+/g, '_');

                if (currentStatus === 'scheduled') {
                    actionButtonHTML = `<button class="btn btn-sm btn-primary action-trip-btn" data-service-id="${service.idService}" data-action="start"><i class="bi bi-play-circle-fill me-1"></i>Start Trip</button>`;
                } else if (currentStatus === 'in_progress') {
                    actionButtonHTML = `<button class="btn btn-sm btn-warning text-dark action-trip-btn" data-service-id="${service.idService}" data-action="end"><i class="bi bi-stop-circle-fill me-1"></i>End Trip</button>`;
                } else if (currentStatus === 'completed') {
                    actionButtonHTML = `<span class="text-success fw-bold"><i class="bi bi-check-circle-fill me-1"></i> Completed</span>`;
                } else {
                    actionButtonHTML = `<span class="text-muted">No actions</span>`;
                }

                tripCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${service.lieuDepart || 'N/A'} <i class="bi bi-arrow-right-short"></i> ${service.lieuArrivee || 'N/A'}</h5>
                                <p class="card-text mb-1"><i class="bi bi-clock-fill"></i> ${service.heureDepart || 'N/A'} - ${service.heureArrivee || 'N/A'}</p>
                                <p class="card-text"><i class="bi bi-truck"></i> ${service.type || 'N/A'} (${service.matricule || 'N/A'})</p>
                            </div>
                            <div>
                                <span class='trip-status ${getStatusClass(service.status)}'>${(service.status || 'N/A').replace('_', ' ')}</span>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <p class="card-text mb-0"><i class="bi bi-people-fill"></i> ${service.capacite || 0} Passengers</p>
                            <div id="action-btn-container-${service.idService}">${actionButtonHTML}</div>
                        </div>
                    </div>
                `;
                todayTripsContainer.appendChild(tripCard);
            });
        }

        async function fetchAllDriverServices() {
            if (!tripsTableBody) return;
            const messageElement = document.getElementById('trips-table-message');
            if (messageElement) messageElement.style.display = 'none'; // Hide message initially

            try {
                const response = await fetch('/api/services/driver/getservice', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        alert("Session expired or invalid. Please login again.");
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const servicesData = await response.json();

                tripsTableBody.innerHTML = '';
                if (servicesData.length === 0) {
                    tripsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><i class="bi bi-emoji-frown fs-3 d-block mb-2"></i>No trips assigned at the moment.</td></tr>`;
                } else {
                    servicesData.forEach(service => {
                        const row = document.createElement('tr');
                        const displayDate = service.dateService ? new Date(service.dateService).toLocaleDateString() : 'N/A';
                        row.innerHTML = `
                            <td>${service.lieuDepart || 'N/A'} - ${service.lieuArrivee || 'N/A'}</td>
                            <td>${displayDate}</td>
                            <td>${service.heureDepart || 'N/A'}</td>
                            <td>${service.heureArrivee || 'N/A'}</td>
                            <td>${service.type || 'N/A'} (${service.matricule || 'N/A'})</td>
                            <td>${service.capacite || 0}</td>
                            <td><span class="trip-status ${getStatusClass(service.status)}">${(service.status || 'N/A').replace('_',' ')}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-btn" data-service-id="${service.idService}"><i class="bi bi-eye-fill me-1"></i>View</button>
                            </td>
                        `;
                        tripsTableBody.appendChild(row);
                    });
                }
                // Re-apply current filter if any, except 'all' which is default view
                const activeFilterButton = document.querySelector('#trips-section .btn-group .btn.active');
                if (activeFilterButton && activeFilterButton.dataset.filter !== 'all') {
                    filterTripsByStatus(activeFilterButton.dataset.filter);
                }


                loadDashboardStats(servicesData);
                loadTodayTrips(servicesData);

                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const serviceId = parseInt(this.getAttribute('data-service-id'));
                        const serviceDetails = servicesData.find(s => s.idService === serviceId);
                        viewTripDetails(serviceId, serviceDetails);
                    });
                });

            } catch (error) {
                console.error('Error fetching services:', error);
                if (tripsTableBody) tripsTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle-fill fs-3 d-block mb-2"></i>Failed to load trip data. Please try refreshing.</td></tr>`;
                if (todayTripsContainer) todayTripsContainer.innerHTML = `<div class="alert alert-danger mt-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>Failed to load today's trips.</div>`;
            }
        }

        function loadReservations() {
            if (!reservationsTableBody || !tripFilterSelect) return;
            reservationsTableBody.innerHTML = '';

            const chauffeurServices = localServicesMock.filter(service => service.idChauffeur === (currentChauffeur.id || 1));
            const serviceIds = chauffeurServices.map(service => service.idService);

            const selectedTripId = tripFilterSelect.value ? parseInt(tripFilterSelect.value) : null;

            const chauffeurReservations = reservations.filter(res =>
                serviceIds.includes(res.idService) &&
                (!selectedTripId || res.idService === selectedTripId)
            );

            if (chauffeurReservations.length === 0) {
                reservationsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><i class="bi bi-search fs-3 d-block mb-2"></i>No reservations found for the selected criteria.</td></tr>`;
            } else {
                chauffeurReservations.forEach(reservation => {
                    const service = localServicesMock.find(s => s.idService === reservation.idService);
                    const trajet = service ? trajets.find(t => t.idTrajet === service.idTrajet) : null;
                    const passager = passagers.find(p => p.idPassager === reservation.idPassager);
                    const passengerName = passager ? `${passager.prenom} ${passager.nom}` : 'Anonymous';
                    const tripName = trajet ? `${trajet.lieuDepart} - ${trajet.lieuArrivee}` : 'Unknown Trip';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${passengerName}</td>
                        <td>${tripName}</td>
                        <td>${reservation.dateReservation ? new Date(reservation.dateReservation).toLocaleDateString() : 'N/A'}</td>
                        <td>${reservation.nbrPlaces}</td>
                        <td><span class="badge ${reservation.statutPaiement === 'paid' ? 'badge-success' : 'badge-warning'}">${reservation.statutPaiement}</span></td>
                        <td><span class="badge ${getReservationStatusClass(reservation.etat)}">${reservation.etat}</span></td>
                    `;
                    reservationsTableBody.appendChild(row);
                });
            }

            if (tripFilterSelect.options.length <= 1 && chauffeurServices.length > 0) {
                tripFilterSelect.innerHTML = '<option value="">Filter by Trip (All - Mock Data)</option>';
                chauffeurServices.forEach(service => {
                    const trajet = trajets.find(t => t.idTrajet === service.idTrajet);
                    if (trajet) {
                        const option = document.createElement('option');
                        option.value = service.idService;
                        option.textContent = `${trajet.lieuDepart} - ${trajet.lieuArrivee} (${service.heureDepart})`;
                        tripFilterSelect.appendChild(option);
                    }
                });
            } else if (chauffeurServices.length === 0 && tripFilterSelect.options.length <= 1) {
                tripFilterSelect.innerHTML = '<option value="">No trips available for filter (Mock Data)</option>';
            }
        }

        function getReservationStatusClass(status) {
            if (!status) return 'badge-secondary';
            switch (String(status).toLowerCase()) {
                case 'confirmée':
                case 'confirmed':
                    return 'badge-success';
                case 'en attente':
                case 'pending':
                    return 'badge-warning';
                case 'annulée':
                case 'cancelled':
                    return 'badge-danger';
                default:
                    return 'badge-light text-dark';
            }
        }

        function setupEventListeners() {
            navLinks.forEach(link => {
                if (link.id === 'logout-btn') return;
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    contentSections.forEach(section => section.classList.remove('active'));
                    const sectionId = this.getAttribute('data-section');
                    const targetSection = document.getElementById(`${sectionId}-section`);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });

            if (tripFilterSelect) {
                tripFilterSelect.addEventListener('change', loadReservations);
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm("Are you sure you want to logout?")) {
                        localStorage.removeItem('token');
                        window.location.href = 'login';
                    }
                });
            }

            document.querySelectorAll('#trips-section [data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#trips-section [data-filter]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterTripsByStatus(this.getAttribute('data-filter'));
                });
            });

            if (todayTripsContainer) {
                todayTripsContainer.addEventListener('click', async function(event) {
                    const targetButton = event.target.closest('.action-trip-btn');
                    if (targetButton) {
                        const serviceId = parseInt(targetButton.getAttribute('data-service-id'));
                        const action = targetButton.getAttribute('data-action');
                        await updateTripStatus(serviceId, action, targetButton);
                    }
                });
            }
        }

        function filterTripsByStatus(statusFilter) {
            const rows = tripsTableBody.querySelectorAll('tr');
            const messageElement = document.getElementById('trips-table-message');
            let visibleRows = 0;
            let hasActualDataRows = false;

            if (!rows || rows.length === 0) {
                if (messageElement) {
                    messageElement.innerHTML = `<i class="bi bi-info-circle-fill fs-3 d-block mb-2"></i>No trips to display or filter.`;
                    messageElement.style.display = 'block';
                }
                return;
            }

            rows.forEach(row => {
                const firstCell = row.cells[0];
                if (row.cells.length === 1 && firstCell && firstCell.colSpan === 8 && firstCell.textContent.includes("No trips assigned")) {
                    if (statusFilter === 'all') {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                    return;
                }

                hasActualDataRows = true;

                const statusCell = row.children[6];
                const statusSpan = statusCell ? statusCell.querySelector('.trip-status') : null;
                const rowStatusText = statusSpan ? statusSpan.textContent.trim().toLowerCase().replace(/\s+/g, '_') : '';

                if (statusFilter === 'all' || rowStatusText === statusFilter) {
                    row.style.display = '';
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (messageElement) {
                if (hasActualDataRows && visibleRows === 0) {
                    messageElement.innerHTML = `<i class="bi bi-funnel-fill fs-3 d-block mb-2"></i>No trips match the filter: <strong>${statusFilter.replace('_',' ')}</strong>.`;
                    messageElement.style.display = 'block';
                } else if (!hasActualDataRows && statusFilter !== 'all' && visibleRows === 0) {
                    messageElement.innerHTML = `<i class="bi bi-info-circle-fill fs-3 d-block mb-2"></i>No trips available to filter for: <strong>${statusFilter.replace('_',' ')}</strong>.`;
                    messageElement.style.display = 'block';
                } else if (rows.length === visibleRows && rows[0] && rows[0].cells.length === 1 && rows[0].cells[0].colSpan === 8 && statusFilter !== 'all') {
                    // This case: Only the "No trips assigned" row is visible, but a specific filter is active.
                    // It means there were no actual trips, and the placeholder is being (incorrectly) counted as a match.
                    // Or, if it's the placeholder row and it's not 'all' filter.
                    messageElement.innerHTML = `<i class="bi bi-info-circle-fill fs-3 d-block mb-2"></i>No trips available to filter for: <strong>${statusFilter.replace('_',' ')}</strong>.`;
                    messageElement.style.display = 'block';
                    if (rows[0].style.display === '') rows[0].style.display = 'none'; // Ensure placeholder is hidden for specific filter
                } else {
                    messageElement.style.display = 'none';
                    messageElement.innerHTML = '';
                }
            }
        }


        async function updateTripStatus(serviceId, action, buttonElement) {
            let newStatus = '';
            if (action === 'start') newStatus = 'in_progress';
            else if (action === 'end') newStatus = 'completed';
            else {
                console.error('Invalid action for trip status update:', action);
                alert('Invalid action requested.');
                return;
            }

            const originalButtonHTML = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Processing...`;

            try {
                console.log(`Attempting to update service ${serviceId} to status ${newStatus}`);
                const response = await fetch(`/api/services/${serviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({
                        message: 'Server error or invalid response.'
                    }));
                    if (response.status === 401) {
                        alert("Session expired or invalid. Please login again.");
                        window.location.href = 'login';
                        return;
                    }
                    throw new Error(errorData.message || `Failed to update trip status. Server responded with ${response.status}`);
                }

                await fetchAllDriverServices();

            } catch (error) {
                console.error('Error updating trip status:', error);
                alert(`Error: ${error.message || 'Could not update trip status.'}`);
                await fetchAllDriverServices();
            }
        }

        function viewTripDetails(serviceId, serviceDetailsFromApi) {
            let detailsMessage = "Trip Details:\n\n";
            if (serviceDetailsFromApi) {
                detailsMessage += `Route: ${serviceDetailsFromApi.lieuDepart || 'N/A'} to ${serviceDetailsFromApi.lieuArrivee || 'N/A'}\n`;
                detailsMessage += `Date: ${serviceDetailsFromApi.dateService ? new Date(serviceDetailsFromApi.dateService).toLocaleDateString() : 'N/A'}\n`;
                detailsMessage += `Departure: ${serviceDetailsFromApi.heureDepart || 'N/A'}\n`;
                detailsMessage += `Arrival: ${serviceDetailsFromApi.heureArrivee || 'N/A'}\n`;
                detailsMessage += `Vehicle: ${serviceDetailsFromApi.type || 'N/A'} (${serviceDetailsFromApi.matricule || 'N/A'})\n`;
                detailsMessage += `Capacity: ${serviceDetailsFromApi.capacite || 0}\n`;
                detailsMessage += `Status: ${(serviceDetailsFromApi.status || 'N/A').replace('_',' ')}\n`;
            } else {
                const service = localServicesMock.find(s => s.idService === serviceId);
                if (!service) {
                    alert("Details not found for this trip (mock).");
                    return;
                }
                const trajet = trajets.find(t => t.idTrajet === service.idTrajet);
                const moyen = moyens.find(m => m.idMoyen === service.idMoyen);

                detailsMessage += `Route: ${trajet?.lieuDepart || 'N/A'} to ${trajet?.lieuArrivee || 'N/A'} (Mock Data)\n`;
                detailsMessage += `Departure: ${service.heureDepart || 'N/A'}\n`;
                detailsMessage += `Vehicle: ${moyen?.type || 'N/A'} (${moyen?.matricule || 'N/A'}) (Mock Data)`;
            }
            alert(detailsMessage);
        }
    </script>
</body>

</html>